---
{"kind": "pipeline", "type": "docker", "name": "parallel-apiShareManagement", "platform": {"os": "linux", "arch": "amd64"}, "steps": [{"name": "clone-core-repos", "image": "owncloudci/alpine:latest", "commands": ["source /drone/src/.drone.env", "git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing", "git clone -b $CORE_BRANCH --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner", "cd /srv/app/testrunner", "git checkout $CORE_COMMITID"], "volumes": [{"name": "oC10Tests", "path": "/srv/app"}]}, {"name": "copy-configs", "image": "owncloud/server:10", "pull": "always", "commands": ["mkdir -p /etc/ocis", "cp /drone/src/tests/parallelDeployAcceptance/drone/ocis/proxy.json /etc/ocis/proxy.json", "mkdir -p /etc/templates", "mkdir -p /etc/pre_server.d", "cp /drone/src/tests/parallelDeployAcceptance/drone/oc10/oidc.config.php /etc/templates/oidc.config.php", "cp /drone/src/tests/parallelDeployAcceptance/drone/oc10/ldap-config.tmpl.json /etc/templates/ldap-config.tmpl.json", "cp /drone/src/tests/parallelDeployAcceptance/drone/oc10/10-custom-config.sh /etc/pre_server.d/10-custom-config.sh"], "volumes": [{"name": "proxy-config", "path": "/etc/ocis"}, {"name": "oc10-templates", "path": "/etc/templates"}, {"name": "preserver-config", "path": "/etc/pre_server.d"}]}, {"name": "wait-for-services", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it oc10-db:3306 -t 300", "wait-for -it openldap:636 -t 300"]}, {"name": "oc10", "image": "owncloud/server:10", "pull": "always", "detach": true, "environment": {"OWNCLOUD_DEFAULT_APP": "files", "OWNCLOUD_WEB_REWRITE_LINKS": "false", "IDP_OIDC_ISSUER": "https://keycloak/auth/realms/owncloud", "IDP_OIDC_CLIENT_SECRET": "oc10-oidc-secret", "CLOUD_DOMAIN": "ocis:9200", "LDAP_HOST": "openldap", "LDAP_PORT": 389, "STORAGE_LDAP_BIND_DN": "cn=admin,dc=owncloud,dc=com", "STORAGE_LDAP_BIND_PASSWORD": "admin", "LDAP_BASE_DN": "dc=owncloud,dc=com", "LDAP_USER_SCHEMA_DISPLAYNAME": "displayname", "LDAP_LOGINFILTER": "(&(objectclass=owncloud)(|(uid=%uid)(mail=%uid)))", "LDAP_GROUP_SCHEMA_DISPLAYNAME": "cn", "LDAP_USER_SCHEMA_NAME_ATTR": "uid", "LDAP_GROUPFILTER": "(&(objectclass=groupOfUniqueNames)(objectclass=owncloud))", "LDAP_USER_SCHEMA_UID": "ownclouduuid", "LDAP_USERATTRIBUTEFILTERS": "uid", "LDAP_USER_SCHEMA_MAIL": "mail", "LDAP_USERFILTER": "(&(objectclass=owncloud))", "LDAP_GROUP_MEMBER_ASSOC_ATTR": "uniqueMember", "OWNCLOUD_DB_TYPE": "mysql", "OWNCLOUD_DB_NAME": "owncloud", "OWNCLOUD_DB_USERNAME": "owncloud", "OWNCLOUD_DB_PASSWORD": "owncloud", "OWNCLOUD_DB_HOST": "oc10-db", "OWNCLOUD_ADMIN_USERNAME": "admin", "OWNCLOUD_ADMIN_PASSWORD": "admin", "OWNCLOUD_MYSQL_UTF8MB4": "true", "OWNCLOUD_REDIS_ENABLED": "true", "OWNCLOUD_REDIS_HOST": "redis", "OWNCLOUD_TRUSTED_PROXIES": "ocis:9200", "OWNCLOUD_OVERWRITE_PROTOCOL": "https", "OWNCLOUD_OVERWRITE_HOST": "ocis:9200", "OWNCLOUD_APPS_ENABLE": "openidconnect,oauth2,user_ldap,graphapi", "OWNCLOUD_LOG_LEVEL": 2, "OWNCLOUD_LOG_FILE": "/mnt/data/owncloud.log"}, "volumes": [{"name": "data", "path": "/mnt/data"}, {"name": "core-apps", "path": "/var/www/owncloud/apps"}, {"name": "oc10-templates", "path": "/etc/templates"}, {"name": "preserver-config", "path": "/etc/pre_server.d"}], "depends_on": ["wait-for-services", "copy-configs"]}, {"name": "wait-for-oc10", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it oc10:8080 -t 300"], "depends_on": ["wait-for-services"]}, {"name": "owncloud-log", "image": "owncloud/ubuntu:18.04", "pull": "always", "detach": true, "commands": ["tail -f /mnt/data/owncloud.log"], "volumes": [{"name": "data", "path": "/mnt/data"}], "depends_on": ["wait-for-oc10"]}, {"name": "fix-permissions", "image": "owncloudci/php:7.4", "pull": "always", "commands": ["chown -R www-data:www-data /var/www/owncloud/apps", "chmod -R 777 /var/www/owncloud/apps", "chmod -R 777 /mnt/data/"], "volumes": [{"name": "core-apps", "path": "/var/www/owncloud/apps"}, {"name": "data", "path": "/mnt/data"}], "depends_on": ["wait-for-oc10"]}, {"name": "ocis", "image": "owncloud/ocis:latest", "environment": {"PROXY_OIDC_ISSUER": "https://keycloak/auth/realmsowncloud", "WEB_OIDC_AUTHORITY": "https://keycloak/auth/realms/owncloud", "WEB_OIDC_CLIENT_ID": "ocis-web", "WEB_OIDC_METADATA_URL": "https://keycloak/auth/realms/owncloud/.well-known/openid-configuration", "STORAGE_OIDC_ISSUER": "https://keycloak", "STORAGE_LDAP_IDP": "https://keycloak/auth/realms/owncloud", "WEB_OIDC_SCOPE": "openid profile email owncloud", "STORAGE_LDAP_HOSTNAME": "openldap", "STORAGE_LDAP_PORT": 636, "STORAGE_LDAP_INSECURE": "true", "STORAGE_LDAP_BIND_DN": "cn=admin,dc=owncloud,dc=com", "STORAGE_LDAP_BIND_PASSWORD": "admin", "PROXY_AUTOPROVISION_ACCOUNTS": "true", "PROXY_ACCOUNT_BACKEND_TYPE": "cs3", "PROXY_USER_OIDC_CLAIM": "ocis.user.uuid", "PROXY_USER_CS3_CLAIM": "userid", "STORAGE_LDAP_BASE_DN": "dc=owncloud,dc=com", "STORAGE_LDAP_GROUP_SCHEMA_DISPLAYNAME": "cn", "STORAGE_LDAP_GROUP_SCHEMA_GID_NUMBER": "gidnumber", "STORAGE_LDAP_GROUP_SCHEMA_GID": "cn", "STORAGE_LDAP_GROUP_SCHEMA_MAIL": "mail", "STORAGE_LDAP_GROUPATTRIBUTEFILTER": "(&(objectclass=posixGroup)(objectclass=owncloud)({{attr}}={{value}}))", "STORAGE_LDAP_GROUPFILTER": "(&(objectclass=groupOfUniqueNames)(objectclass=owncloud)(ownclouduuid={{.OpaqueId}}*))", "STORAGE_LDAP_GROUPMEMBERFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(ownclouduuid={{.OpaqueId}}*))", "STORAGE_LDAP_USERGROUPFILTER": "(&(objectclass=posixGroup)(objectclass=owncloud)(ownclouduuid={{.OpaqueId}}*))", "STORAGE_LDAP_USER_SCHEMA_CN": "cn", "STORAGE_LDAP_USER_SCHEMA_DISPLAYNAME": "displayname", "STORAGE_LDAP_USER_SCHEMA_GID_NUMBER": "gidnumber", "STORAGE_LDAP_USER_SCHEMA_MAIL": "mail", "STORAGE_LDAP_USER_SCHEMA_UID_NUMBER": "uidnumber", "STORAGE_LDAP_USER_SCHEMA_UID": "ownclouduuid", "STORAGE_LDAP_LOGINFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(|(uid={{login}})(mail={{login}})))", "STORAGE_LDAP_USERATTRIBUTEFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)({{attr}}={{value}}))", "STORAGE_LDAP_USERFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(|(ownclouduuid={{.OpaqueId}})(uid={{.OpaqueId}})))", "STORAGE_LDAP_USERFINDFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(|(cn={{query}}*)(displayname={{query}}*)(mail={{query}}*)))", "STORAGE_HOME_DRIVER": "owncloudsql", "STORAGE_USERS_DRIVER": "owncloudsql", "STORAGE_METADATA_DRIVER": "ocis", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DATADIR": "/mnt/data/files", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_UPLOADINFO_DIR": "/tmp", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_SHARE_FOLDER": "/Shares", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_LAYOUT": "{{.Username}}", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBUSERNAME": "owncloud", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBPASSWORD": "owncloud", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBHOST": "oc10-db", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBPORT": 3306, "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBNAME": "owncloud", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_REDIS_ADDR": "redis:6379", "OCIS_STORAGE_READ_ONLY": "false", "OCIS_LOG_LEVEL": "error", "OCIS_URL": "https://ocis:9200", "PROXY_TLS": "true", "OCIS_JWT_SECRET": "Pive-Fumkiu4", "STORAGE_TRANSFER_SECRET": "replace-me-with-a-transfer-secret", "OCIS_MACHINE_AUTH_API_KEY": "change-me-please", "OCIS_INSECURE": "true", "PROXY_ENABLE_BASIC_AUTH": "true"}, "detach": true, "commands": ["ocis server"], "volumes": [{"name": "data", "path": "/mnt/data"}, {"name": "proxy-config", "path": "/etc/ocis"}], "user": "33:33", "depends_on": ["fix-permissions"]}, {"name": "wait-for-ocis", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it ocis:9200 -t 300"], "depends_on": ["wait-for-oc10"]}, {"name": "acceptance-tests", "image": "owncloudci/php:7.4", "environment": {"TEST_SERVER_URL": "https://ocis:9200", "TEST_OC10_URL": "http://oc10:8080", "TEST_PARALLEL_DEPLOYMENT": "true", "TEST_OCIS": "true", "TEST_WITH_LDAP": "true", "REVA_LDAP_PORT": 636, "REVA_LDAP_BASE_DN": "dc=owncloud,dc=com", "REVA_LDAP_HOSTNAME": "openldap", "REVA_LDAP_BIND_DN": "cn=admin,dc=owncloud,dc=com", "SKELETON_DIR": "/var/www/owncloud/apps/testing/data/apiSkeleton", "PATH_TO_CORE": "/srv/app/testrunner", "OCIS_REVA_DATA_ROOT": "", "EXPECTED_FAILURES_FILE": "/drone/src/tests/parallelDeployAcceptance/expected-failures-API.md", "BEHAT_FILTER_TAGS": "~@skip", "BEHAT_SUITE": "apiShareManagement"}, "commands": ["make test-paralleldeployment-api"], "depends_on": ["clone-core-repos", "wait-for-oc10", "wait-for-ocis"], "volumes": [{"name": "core-apps", "path": "/var/www/owncloud/apps"}, {"name": "oC10Tests", "path": "/srv/app"}]}], "services": [{"name": "keycloak-db", "image": "postgres:alpine", "pull": "always", "environment": {"POSTGRES_DB": "keycloak", "POSTGRES_USER": "keycloak", "POSTGRES_PASSWORD": "keycloak"}}, {"name": "oc10-db", "image": "mariadb:10.6", "pull": "always", "environment": {"MYSQL_ROOT_PASSWORD": "owncloud", "MYSQL_USER": "owncloud", "MYSQL_PASSWORD": "owncloud", "MYSQL_DATABASE": "owncloud"}, "command": ["--max-allowed-packet=128M", "--innodb-log-file-size=64M", "--innodb-read-only-compressed=OFF"]}, {"name": "openldap", "image": "osixia/openldap:latest", "pull": "always", "environment": {"LDAP_TLS_VERIFY_CLIENT": "never", "LDAP_DOMAIN": "owncloud.com", "LDAP_ORGANISATION": "owncloud", "LDAP_ADMIN_PASSWORD": "admin", "LDAP_RFC2307BIS_SCHEMA": "true", "LDAP_REMOVE_CONFIG_AFTER_SETUP": "false", "LDAP_SEED_INTERNAL_LDIF_PATH": "/drone/src/tests/parallelDeployAcceptance/drone/ldap/ldif"}, "command": ["--copy-service", "--loglevel", "debug"]}, {"name": "redis", "image": "redis:6-alpine"}, {"name": "keycloak", "image": "quay.io/keycloak/keycloak:latest", "pull": "always", "environment": {"CLOUD_DOMAIN": "ocis:9200", "OC10_OIDC_CLIENT_SECRET": "oc10-oidc-secret", "LDAP_ADMIN_PASSWORD": "admin", "DB_VENDOR": "POSTGRES", "DB_ADDR": "keycloak-db", "DB_DATABASE": "keycloak", "DB_USER": "keycloak", "DB_SCHEMA": "public", "DB_PASSWORD": "keycloak", "KEYCLOAK_USER": "admin", "KEYCLOAK_PASSWORD": "admin", "PROXY_ADDRESS_FORWARDING": "true", "KEYCLOAK_IMPORT": "/drone/src/tests/parallelDeployAcceptance/drone/keycloak/owncloud-realm.json"}}], "volumes": [{"name": "oc10-templates", "temp": {}}, {"name": "preserver-config", "temp": {}}, {"name": "core-apps", "temp": {}}, {"name": "data", "temp": {}}, {"name": "proxy-config", "temp": {}}, {"name": "oC10Tests", "temp": {}}], "trigger": {"ref": ["refs/pull/**"]}}
---
{"kind": "pipeline", "type": "docker", "name": "parallel-apiWebdavOperations", "platform": {"os": "linux", "arch": "amd64"}, "steps": [{"name": "clone-core-repos", "image": "owncloudci/alpine:latest", "commands": ["source /drone/src/.drone.env", "git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing", "git clone -b $CORE_BRANCH --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner", "cd /srv/app/testrunner", "git checkout $CORE_COMMITID"], "volumes": [{"name": "oC10Tests", "path": "/srv/app"}]}, {"name": "copy-configs", "image": "owncloud/server:10", "pull": "always", "commands": ["mkdir -p /etc/ocis", "cp /drone/src/tests/parallelDeployAcceptance/drone/ocis/proxy.json /etc/ocis/proxy.json", "mkdir -p /etc/templates", "mkdir -p /etc/pre_server.d", "cp /drone/src/tests/parallelDeployAcceptance/drone/oc10/oidc.config.php /etc/templates/oidc.config.php", "cp /drone/src/tests/parallelDeployAcceptance/drone/oc10/ldap-config.tmpl.json /etc/templates/ldap-config.tmpl.json", "cp /drone/src/tests/parallelDeployAcceptance/drone/oc10/10-custom-config.sh /etc/pre_server.d/10-custom-config.sh"], "volumes": [{"name": "proxy-config", "path": "/etc/ocis"}, {"name": "oc10-templates", "path": "/etc/templates"}, {"name": "preserver-config", "path": "/etc/pre_server.d"}]}, {"name": "wait-for-services", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it oc10-db:3306 -t 300", "wait-for -it openldap:636 -t 300"]}, {"name": "oc10", "image": "owncloud/server:10", "pull": "always", "detach": true, "environment": {"OWNCLOUD_DEFAULT_APP": "files", "OWNCLOUD_WEB_REWRITE_LINKS": "false", "IDP_OIDC_ISSUER": "https://keycloak/auth/realms/owncloud", "IDP_OIDC_CLIENT_SECRET": "oc10-oidc-secret", "CLOUD_DOMAIN": "ocis:9200", "LDAP_HOST": "openldap", "LDAP_PORT": 389, "STORAGE_LDAP_BIND_DN": "cn=admin,dc=owncloud,dc=com", "STORAGE_LDAP_BIND_PASSWORD": "admin", "LDAP_BASE_DN": "dc=owncloud,dc=com", "LDAP_USER_SCHEMA_DISPLAYNAME": "displayname", "LDAP_LOGINFILTER": "(&(objectclass=owncloud)(|(uid=%uid)(mail=%uid)))", "LDAP_GROUP_SCHEMA_DISPLAYNAME": "cn", "LDAP_USER_SCHEMA_NAME_ATTR": "uid", "LDAP_GROUPFILTER": "(&(objectclass=groupOfUniqueNames)(objectclass=owncloud))", "LDAP_USER_SCHEMA_UID": "ownclouduuid", "LDAP_USERATTRIBUTEFILTERS": "uid", "LDAP_USER_SCHEMA_MAIL": "mail", "LDAP_USERFILTER": "(&(objectclass=owncloud))", "LDAP_GROUP_MEMBER_ASSOC_ATTR": "uniqueMember", "OWNCLOUD_DB_TYPE": "mysql", "OWNCLOUD_DB_NAME": "owncloud", "OWNCLOUD_DB_USERNAME": "owncloud", "OWNCLOUD_DB_PASSWORD": "owncloud", "OWNCLOUD_DB_HOST": "oc10-db", "OWNCLOUD_ADMIN_USERNAME": "admin", "OWNCLOUD_ADMIN_PASSWORD": "admin", "OWNCLOUD_MYSQL_UTF8MB4": "true", "OWNCLOUD_REDIS_ENABLED": "true", "OWNCLOUD_REDIS_HOST": "redis", "OWNCLOUD_TRUSTED_PROXIES": "ocis:9200", "OWNCLOUD_OVERWRITE_PROTOCOL": "https", "OWNCLOUD_OVERWRITE_HOST": "ocis:9200", "OWNCLOUD_APPS_ENABLE": "openidconnect,oauth2,user_ldap,graphapi", "OWNCLOUD_LOG_LEVEL": 2, "OWNCLOUD_LOG_FILE": "/mnt/data/owncloud.log"}, "volumes": [{"name": "data", "path": "/mnt/data"}, {"name": "core-apps", "path": "/var/www/owncloud/apps"}, {"name": "oc10-templates", "path": "/etc/templates"}, {"name": "preserver-config", "path": "/etc/pre_server.d"}], "depends_on": ["wait-for-services", "copy-configs"]}, {"name": "wait-for-oc10", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it oc10:8080 -t 300"], "depends_on": ["wait-for-services"]}, {"name": "owncloud-log", "image": "owncloud/ubuntu:18.04", "pull": "always", "detach": true, "commands": ["tail -f /mnt/data/owncloud.log"], "volumes": [{"name": "data", "path": "/mnt/data"}], "depends_on": ["wait-for-oc10"]}, {"name": "fix-permissions", "image": "owncloudci/php:7.4", "pull": "always", "commands": ["chown -R www-data:www-data /var/www/owncloud/apps", "chmod -R 777 /var/www/owncloud/apps", "chmod -R 777 /mnt/data/"], "volumes": [{"name": "core-apps", "path": "/var/www/owncloud/apps"}, {"name": "data", "path": "/mnt/data"}], "depends_on": ["wait-for-oc10"]}, {"name": "ocis", "image": "owncloud/ocis:latest", "environment": {"PROXY_OIDC_ISSUER": "https://keycloak/auth/realmsowncloud", "WEB_OIDC_AUTHORITY": "https://keycloak/auth/realms/owncloud", "WEB_OIDC_CLIENT_ID": "ocis-web", "WEB_OIDC_METADATA_URL": "https://keycloak/auth/realms/owncloud/.well-known/openid-configuration", "STORAGE_OIDC_ISSUER": "https://keycloak", "STORAGE_LDAP_IDP": "https://keycloak/auth/realms/owncloud", "WEB_OIDC_SCOPE": "openid profile email owncloud", "STORAGE_LDAP_HOSTNAME": "openldap", "STORAGE_LDAP_PORT": 636, "STORAGE_LDAP_INSECURE": "true", "STORAGE_LDAP_BIND_DN": "cn=admin,dc=owncloud,dc=com", "STORAGE_LDAP_BIND_PASSWORD": "admin", "PROXY_AUTOPROVISION_ACCOUNTS": "true", "PROXY_ACCOUNT_BACKEND_TYPE": "cs3", "PROXY_USER_OIDC_CLAIM": "ocis.user.uuid", "PROXY_USER_CS3_CLAIM": "userid", "STORAGE_LDAP_BASE_DN": "dc=owncloud,dc=com", "STORAGE_LDAP_GROUP_SCHEMA_DISPLAYNAME": "cn", "STORAGE_LDAP_GROUP_SCHEMA_GID_NUMBER": "gidnumber", "STORAGE_LDAP_GROUP_SCHEMA_GID": "cn", "STORAGE_LDAP_GROUP_SCHEMA_MAIL": "mail", "STORAGE_LDAP_GROUPATTRIBUTEFILTER": "(&(objectclass=posixGroup)(objectclass=owncloud)({{attr}}={{value}}))", "STORAGE_LDAP_GROUPFILTER": "(&(objectclass=groupOfUniqueNames)(objectclass=owncloud)(ownclouduuid={{.OpaqueId}}*))", "STORAGE_LDAP_GROUPMEMBERFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(ownclouduuid={{.OpaqueId}}*))", "STORAGE_LDAP_USERGROUPFILTER": "(&(objectclass=posixGroup)(objectclass=owncloud)(ownclouduuid={{.OpaqueId}}*))", "STORAGE_LDAP_USER_SCHEMA_CN": "cn", "STORAGE_LDAP_USER_SCHEMA_DISPLAYNAME": "displayname", "STORAGE_LDAP_USER_SCHEMA_GID_NUMBER": "gidnumber", "STORAGE_LDAP_USER_SCHEMA_MAIL": "mail", "STORAGE_LDAP_USER_SCHEMA_UID_NUMBER": "uidnumber", "STORAGE_LDAP_USER_SCHEMA_UID": "ownclouduuid", "STORAGE_LDAP_LOGINFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(|(uid={{login}})(mail={{login}})))", "STORAGE_LDAP_USERATTRIBUTEFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)({{attr}}={{value}}))", "STORAGE_LDAP_USERFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(|(ownclouduuid={{.OpaqueId}})(uid={{.OpaqueId}})))", "STORAGE_LDAP_USERFINDFILTER": "(&(objectclass=posixAccount)(objectclass=owncloud)(|(cn={{query}}*)(displayname={{query}}*)(mail={{query}}*)))", "STORAGE_HOME_DRIVER": "owncloudsql", "STORAGE_USERS_DRIVER": "owncloudsql", "STORAGE_METADATA_DRIVER": "ocis", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DATADIR": "/mnt/data/files", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_UPLOADINFO_DIR": "/tmp", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_SHARE_FOLDER": "/Shares", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_LAYOUT": "{{.Username}}", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBUSERNAME": "owncloud", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBPASSWORD": "owncloud", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBHOST": "oc10-db", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBPORT": 3306, "STORAGE_USERS_DRIVER_OWNCLOUDSQL_DBNAME": "owncloud", "STORAGE_USERS_DRIVER_OWNCLOUDSQL_REDIS_ADDR": "redis:6379", "OCIS_STORAGE_READ_ONLY": "false", "OCIS_LOG_LEVEL": "error", "OCIS_URL": "https://ocis:9200", "PROXY_TLS": "true", "OCIS_JWT_SECRET": "Pive-Fumkiu4", "STORAGE_TRANSFER_SECRET": "replace-me-with-a-transfer-secret", "OCIS_MACHINE_AUTH_API_KEY": "change-me-please", "OCIS_INSECURE": "true", "PROXY_ENABLE_BASIC_AUTH": "true"}, "detach": true, "commands": ["ocis server"], "volumes": [{"name": "data", "path": "/mnt/data"}, {"name": "proxy-config", "path": "/etc/ocis"}], "user": "33:33", "depends_on": ["fix-permissions"]}, {"name": "wait-for-ocis", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it ocis:9200 -t 300"], "depends_on": ["wait-for-oc10"]}, {"name": "acceptance-tests", "image": "owncloudci/php:7.4", "environment": {"TEST_SERVER_URL": "https://ocis:9200", "TEST_OC10_URL": "http://oc10:8080", "TEST_PARALLEL_DEPLOYMENT": "true", "TEST_OCIS": "true", "TEST_WITH_LDAP": "true", "REVA_LDAP_PORT": 636, "REVA_LDAP_BASE_DN": "dc=owncloud,dc=com", "REVA_LDAP_HOSTNAME": "openldap", "REVA_LDAP_BIND_DN": "cn=admin,dc=owncloud,dc=com", "SKELETON_DIR": "/var/www/owncloud/apps/testing/data/apiSkeleton", "PATH_TO_CORE": "/srv/app/testrunner", "OCIS_REVA_DATA_ROOT": "", "EXPECTED_FAILURES_FILE": "/drone/src/tests/parallelDeployAcceptance/expected-failures-API.md", "BEHAT_FILTER_TAGS": "~@skip", "BEHAT_SUITE": "apiWebdavOperations"}, "commands": ["make test-paralleldeployment-api"], "depends_on": ["clone-core-repos", "wait-for-oc10", "wait-for-ocis"], "volumes": [{"name": "core-apps", "path": "/var/www/owncloud/apps"}, {"name": "oC10Tests", "path": "/srv/app"}]}], "services": [{"name": "keycloak-db", "image": "postgres:alpine", "pull": "always", "environment": {"POSTGRES_DB": "keycloak", "POSTGRES_USER": "keycloak", "POSTGRES_PASSWORD": "keycloak"}}, {"name": "oc10-db", "image": "mariadb:10.6", "pull": "always", "environment": {"MYSQL_ROOT_PASSWORD": "owncloud", "MYSQL_USER": "owncloud", "MYSQL_PASSWORD": "owncloud", "MYSQL_DATABASE": "owncloud"}, "command": ["--max-allowed-packet=128M", "--innodb-log-file-size=64M", "--innodb-read-only-compressed=OFF"]}, {"name": "openldap", "image": "osixia/openldap:latest", "pull": "always", "environment": {"LDAP_TLS_VERIFY_CLIENT": "never", "LDAP_DOMAIN": "owncloud.com", "LDAP_ORGANISATION": "owncloud", "LDAP_ADMIN_PASSWORD": "admin", "LDAP_RFC2307BIS_SCHEMA": "true", "LDAP_REMOVE_CONFIG_AFTER_SETUP": "false", "LDAP_SEED_INTERNAL_LDIF_PATH": "/drone/src/tests/parallelDeployAcceptance/drone/ldap/ldif"}, "command": ["--copy-service", "--loglevel", "debug"]}, {"name": "redis", "image": "redis:6-alpine"}, {"name": "keycloak", "image": "quay.io/keycloak/keycloak:latest", "pull": "always", "environment": {"CLOUD_DOMAIN": "ocis:9200", "OC10_OIDC_CLIENT_SECRET": "oc10-oidc-secret", "LDAP_ADMIN_PASSWORD": "admin", "DB_VENDOR": "POSTGRES", "DB_ADDR": "keycloak-db", "DB_DATABASE": "keycloak", "DB_USER": "keycloak", "DB_SCHEMA": "public", "DB_PASSWORD": "keycloak", "KEYCLOAK_USER": "admin", "KEYCLOAK_PASSWORD": "admin", "PROXY_ADDRESS_FORWARDING": "true", "KEYCLOAK_IMPORT": "/drone/src/tests/parallelDeployAcceptance/drone/keycloak/owncloud-realm.json"}}], "volumes": [{"name": "oc10-templates", "temp": {}}, {"name": "preserver-config", "temp": {}}, {"name": "core-apps", "temp": {}}, {"name": "data", "temp": {}}, {"name": "proxy-config", "temp": {}}, {"name": "oC10Tests", "temp": {}}], "trigger": {"ref": ["refs/pull/**"]}}
